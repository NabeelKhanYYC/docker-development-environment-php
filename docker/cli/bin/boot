#!/bin/bash

echo "Setting up xDebug"
if [ ! -d /opt/xdebug/output/ ]; then
    echo "xDebug output directory not found, creating it"
    mkdir -p /opt/xdebug/output/ || exit 1
    chmod -R 777 /opt/xdebug || exit 1
else
    echo "xDebug output directory found"
fi

if [ ! -f /opt/xdebug/xdebug.log ]; then
    echo "xDebug logfile not found, creating it"
    touch /opt/xdebug/xdebug.log || exit 1
    chmod 777 /opt/xdebug/xdebug.log || exit 1
else
    echo "xDebug logfile found"
fi
echo ""

if [ ! -d /opt/ssh/cli ]; then
    echo "Generating SSH Keys and storing it on the ssh volume"
    mkdir -p /opt/ssh/cli
    echo ""

    echo "Server Key"
    ssh-keygen -N "" -t ed25519 -f /opt/ssh/cli/server
    echo ""

    echo "Client Key"
    ssh-keygen -N "" -t ed25519 -f /opt/ssh/cli/client

    echo "Adding to shared authorized_keys"
    cat /opt/ssh/cli/client.pub
    cat /opt/ssh/cli/client.pub >> /opt/ssh/authorized_keys
    echo ""

    PASSWORD=`/usr/bin/head -c $(od -An -N2 -i /dev/urandom | tr -d ' ') /dev/urandom | /usr/bin/md5sum | awk '{print $1}'`

    echo "Setting root password to '${PASSWORD}'"
    echo root:$PASSWORD | chpasswd
    echo ""
fi

if [ ! -L /root/.ssh/authorized_keys ]; then
    if [ -f /root/.ssh/authorized_keys ]; then
        mv /root/.ssh/authorized_keys /root/.ssh/authorized_keys.old
    fi
    ln -s /opt/ssh/authorized_keys /root/.ssh/authorized_keys
fi

echo "Starting SSH..."
/usr/sbin/sshd -D -e
echo "FATAL: SSH process ended."
