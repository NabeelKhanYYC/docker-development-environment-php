#!/bin/bash

echo "Setting up xDebug"
if [ ! -d /opt/xdebug/output/ ]; then
    echo "xDebug output directory not found, creating it"
    mkdir -p /opt/xdebug/output/ || exit 1
    chmod -R 755 /opt/xdebug/ || exit 1
else
    echo "xDebug output directory found"
fi

if [ ! -f /opt/xdebug/xdebug.log ]; then
    echo "xDebug logfile not found, creating it"
    touch /opt/xdebug/xdebug.log || exit 1
else
    echo "xDebug logfile found"
fi
echo ""

VSCODE_PLUGINS_TO_INSTALL=("bmewburn.vscode-intelephense-client", "xdebug.php-debug")
echo "Checking VSCode Plugins"

if [ -n "$VSCODE_PLUGINS" ] && [ "$VSCODE_PLUGINS" != "''" ]; then
    if [[ "$VSCODE_PLUGINS" == *";"* ]]; then
        IFS=';' read -ra VSCODE_PLUGINS_ADDITIONAL <<< "$VSCODE_PLUGINS"
        if [ ${#VSCODE_PLUGINS_ADDITIONAL[@]} -gt 0 ]; then
            echo "Found ${#VSCODE_PLUGINS_ADDITIONAL[@]} additional plugins to install"
            VSCODE_PLUGINS_TO_INSTALL+=("${VSCODE_PLUGINS_ADDITIONAL[@]}")
        fi
    else
        echo "Only one additional plugin detected. If there should be more seperate them with semicolon (;)"
        VSCODE_PLUGINS_TO_INSTALL+=("$VSCODE_PLUGINS")
    fi
else
    echo "No additional VSCode Plugins configured."
    echo "Set VSCODE_PLUGINS environment variable with arrays of plugins to install (seperate with ;)"
fi

if [ ${#VSCODE_PLUGINS_TO_INSTALL[@]} -eq 0 ]; then
    echo "No VSCode Plugins configured at all"
else
    if [ ! -f /opt/vscode/data/extensions/extensions.json ]; then
        for Plugin in "${VSCODE_PLUGINS_TO_INSTALL[@]}"; do
            Plugin=${Plugin%,}
            if [ ls /opt/vscode/data/extensions/${Plugin}-* &> /dev/null ]; then
                echo "Found: ${Plugin}"
            else
                echo "Installing: ${Plugin}"
                /opt/vscode/bin/code-server --force --install-extension ${Plugin}
            fi
        done

        echo "Copying over local extensions to data directory"
        mkdir -p /opt/vscode/data/extensions/
        cp -a /root/.local/share/code-server/extensions/* /opt/vscode/data/extensions/
    else
        echo "Pre-existing installation detected, no extensions installed to prevent any conflicts"
    fi
fi
echo ""

VSCODE_AUTH=${VSCODE_AUTH:-password}
echo "Starting VSCode Server"
echo "    Port: $PORT_VSCODE"
echo "    Path: $PATH_VSCODE_PROJECT"
echo "    Auth: $VSCODE_AUTH"

if [[ -n "$VSCODE_PASSWORD" && "$VSCODE_PASSWORD" != "''" ]]; then
    echo "    Pass: Value from 'VSCODE_PASSWORD' environment variable"
    PASSWORD=$VSCODE_PASSWORD
fi

if [[ "$VSCODE_AUTH" == "password" && -z "$PASSWORD" ]]; then
    PASSWORD=`/usr/bin/head -c $(od -An -N2 -i /dev/urandom | tr -d ' ') /dev/urandom | /usr/bin/md5sum | awk '{print $1}'`
    PASSWORD=${PASSWORD:4:24}
    echo "    Pass: $PASSWORD"
fi
echo ""

if [ ! -z "$PASSWORD" ]; then
    export PASSWORD=$PASSWORD
fi
mkdir -p /opt/vscode/data/config /opt/vscode/data/extensions
/opt/vscode/bin/code-server \
    --app-name "Development Environment (PHP)" \
    --bind-addr 0.0.0.0:$PORT_VSCODE \
    --user-data-dir /opt/vscode/data/config \
    --extensions-dir /opt/vscode/data/extensions \
    --disable-telemetry \
    --disable-update-check \
    --disable-getting-started-override \
    --cert \
    --auth "$VSCODE_AUTH" \
    $PATH_VSCODE_PROJECT &> /opt/log/vscode.log & 

if [ ! -z "$PASSWORD" ]; then
    # We don't need this in the environment (either you know it or you don't)
    unset PASSWORD
fi

echo "Waiting for VSCode Server to start.."
until nc -z localhost $PORT_VSCODE; do
    sleep 1
done
echo ""

echo "Starting Cron"
/usr/sbin/cron -f -l 1 2>&1 >> /opt/log/cron.log &
crontab -u root /etc/cron.d/default
echo ""

if [ ! -d /opt/ssh/ide ]; then
    echo "Generating SSH Keys and storing it on the ssh volume"
    mkdir -p /opt/ssh/ide
    echo ""

    echo "Server Key"
    ssh-keygen -N "" -t ed25519 -f /opt/ssh/ide/server
    echo ""

    echo "Client Key"
    ssh-keygen -N "" -t ed25519 -f /opt/ssh/ide/client

    echo "Adding to shared authorized_keys"
    cat /opt/ssh/ide/client.pub
    cat /opt/ssh/ide/client.pub >> /opt/ssh/authorized_keys
    echo ""    

    PASSWORD=`/usr/bin/head -c $(od -An -N2 -i /dev/urandom | tr -d ' ') /dev/urandom | /usr/bin/md5sum | awk '{print $1}'`

    echo "Setting root password to '${PASSWORD}'"
    echo root:${PASSWORD} | chpasswd
    echo ""
fi

echo "Starting SSH..."
/usr/sbin/sshd -D -e
echo "FATAL: SSH process ended."
